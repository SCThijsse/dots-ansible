---
image: python:3
default: lint
location: /src
tasks:
  install_ansible:
    description: Install Ansible & Molecule.
    command: |
      pip3 install ansible-lint yamllint molecule[docker] docker

  install_docker:
    description: Install Docker.
    environment:
      DEBIAN_FRONTEND: noninteractive
    command: |
      apt-get update
      apt-get install --yes curl lsb-release

      curl -fsSL https://download.docker.com/linux/debian/gpg | \
        gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg

      echo \
        "deb [arch=amd64 signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] "\
        "https://download.docker.com/linux/debian "\
        "$(lsb_release -cs) stable" > /etc/apt/sources.list.d/docker.list

      apt-get update
      apt-get install --yes docker-ce-cli

  install_tools:
    dependencies:
      - install_ansible
      - install_docker

  fetch_dependencies:
    dependencies:
      - install_tools
    environment:
      ANSIBLE_CONFIG: /src/ansible.cfg
      ANSIBLE_FORCE_COLOR: 1
      PY_COLORS: 1
    input_paths:
      - requirements.yml
    command: |
      ansible-galaxy install -r requirements.yml
      ansible-galaxy collection install -v \
          ansible.posix \
          community.docker:>=1.9.1 \
          community.general

  lint:
    description: Run the linters.
    dependencies:
      - fetch_dependencies
    mount_paths:
      - .yamllint
      - main.yml
      - roles
    command: |
      yamllint .
      ansible-lint
    cache: false

  aur:
    dependencies:
      - fetch_dependencies
    mount_paths:
      - roles
      - /var/run/docker.sock
    command: cd roles/aur && molecule test
    cache: false

  dots:
    dependencies:
      - fetch_dependencies
    mount_paths:
      - roles
      - /var/run/docker.sock
    command: cd roles/dots && molecule test
    cache: false

  git:
    dependencies:
      - fetch_dependencies
    mount_paths:
      - roles
      - /var/run/docker.sock
    command: cd roles/git && molecule test
    cache: false

  java:
    dependencies:
      - fetch_dependencies
    mount_paths:
      - roles
      - /var/run/docker.sock
    command: cd roles/lang_java && molecule test
    cache: false

  javascript:
    dependencies:
      - fetch_dependencies
    mount_paths:
      - roles
      - /var/run/docker.sock
    command: cd roles/lang_javascript && molecule test
    cache: false

  go:
    dependencies:
      - fetch_dependencies
    mount_paths:
      - roles
      - /var/run/docker.sock
    command: cd roles/lang_go && molecule test
    cache: false

  k8s:
    dependencies:
      - fetch_dependencies
    mount_paths:
      - roles
      - /var/run/docker.sock
    command: cd roles/lang_k8s && molecule test
    cache: false

  lua:
    dependencies:
      - fetch_dependencies
    mount_paths:
      - roles
      - /var/run/docker.sock
    command: cd roles/lang_lua && molecule test
    cache: false

  python:
    dependencies:
      - fetch_dependencies
    mount_paths:
      - roles
      - /var/run/docker.sock
    command: cd roles/lang_python && molecule test
    cache: false

  neovim:
    dependencies:
      - fetch_dependencies
    mount_paths:
      - roles
      - /var/run/docker.sock
    command: cd roles/neovim && molecule test
    cache: false

  pacman:
    dependencies:
      - fetch_dependencies
    mount_paths:
      - roles
      - /var/run/docker.sock
    command: cd roles/pacman && molecule test
    cache: false

  suckless:
    dependencies:
      - fetch_dependencies
    mount_paths:
      - roles
      - /var/run/docker.sock
    command: cd roles/suckless && molecule test
    cache: false

  system:
    dependencies:
      - fetch_dependencies
    mount_paths:
      - roles
      - /var/run/docker.sock
    command: cd roles/system && molecule test
    cache: false
